<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QR Nexus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Saira:wght@100..900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    
    <div class="status-bar">
        <span class="pulse">QR Codes</span>
    </div>
    
    <div class="container">
        <div class="section">
            <div class="section-header">Crea</div>
            <div class="card">
                <div class="input-wrapper">
                    <span class="material-symbols-outlined">edit_note</span>
                    <input type="text" id="textInput" placeholder="Inserisci testo o URL...">
                </div>
            </div>
            <button class="button" onclick="generateQRCode()">
                <span class="material-symbols-outlined">bolt</span>
                <span>Genera QR Code</span>
            </button>
            <div class="qr-display" id="qrcode">
                <div class="empty-state">
                    <div class="icon-text">
                        <span class="material-symbols-outlined">download</span>
                        <span>Il codice apparirà qui</span>
                    </div>
                    <small style="color: var(--gray); margin-top: 8px;">Clicca sul codice per scaricarlo</small>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">Scansiona</div>
            <div class="button-group">
                <button class="button tertiary" onclick="startCamera()">
                    <span class="material-symbols-outlined">photo_camera</span>
                    <span>Avvia Scanner</span>
                </button>
                <button class="button secondary" onclick="stopCamera()">
                    <span class="material-symbols-outlined">close</span>
                    <span>Interrompi</span>
                </button>
            </div>
            
            <div class="video-container" id="videoContainer">
                <video id="video" autoplay playsinline></video>
                <div class="scan-overlay">
                    <div class="scan-corners">
                        <div class="corner tl"></div>
                        <div class="corner tr"></div>
                        <div class="corner bl"></div>
                        <div class="corner br"></div>
                        <div class="scan-line"></div>
                    </div>
                </div>
                <div class="scan-hint">
                    <span class="material-symbols-outlined">qr_code_scanner</span>
                    <span>Inquadra il codice QR nell'area di scansione</span>
                </div>
            </div>

            <div class="result-card" id="resultCard">
                <div class="result-header">
                    <span class="material-symbols-outlined" id="resultIcon">check_circle</span>
                    <span id="resultTitle">Codice rilevato con successo</span>
                </div>
                <div class="result-text" id="decodedText"></div>
                <div id="otpTableContainer" style="display: none;">
                    <table class="otp-table">
                        <thead>
                            <tr>
                                <th>Parametro</th>
                                <th>Valore</th>
                            </tr>
                        </thead>
                        <tbody id="otpTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                    <div class="otp-info">
                        <span class="material-symbols-outlined">info</span>
                        <span>Questo è un codice 2FA. I valori possono essere copiati usando i pulsanti.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script>
        // Create floating particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particle.style.animationDuration = `${15 + Math.random() * 10}s`;
                particle.style.opacity = 0.1 + Math.random() * 0.2;
                particle.style.background = i % 3 === 0 ? 'var(--primary)' : 
                                          i % 3 === 1 ? 'var(--tertiary)' : 'var(--secondary)';
                container.appendChild(particle);
            }
        }

        createParticles();

        function generateQRCode() {
            const text = document.getElementById('textInput').value;
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = "";
            
            if(text.trim() === "") {
                qrcodeDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="icon-text">
                            <span class="material-symbols-outlined">edit</span>
                            <span>Inserisci del testo per generare il codice</span>
                        </div>
                    </div>`;
                qrcodeDiv.classList.remove('has-code');
                return;
            }
            
            QRCode.toCanvas(document.createElement('canvas'), text, { 
                width: 320,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error, canvas) {
                if (error) {
                    console.error(error);
                    qrcodeDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="icon-text">
                                <span class="material-symbols-outlined">error</span>
                                <span>Errore durante la generazione</span>
                            </div>
                        </div>`;
                    qrcodeDiv.classList.remove('has-code');
                } else {
                    qrcodeDiv.appendChild(canvas);
                    qrcodeDiv.classList.add('has-code');
                    
                    // Add success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'empty-state';
                    successMsg.style.marginTop = '20px';
                    successMsg.innerHTML = `
                        <div class="icon-text">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>QR Code generato con successo!</span>
                        </div>
                        <small style="color: var(--gray); margin-top: 8px;">Clicca sul codice per scaricarlo</small>
                    `;
                    qrcodeDiv.appendChild(successMsg);
                    
                    // Add click to download functionality
                    canvas.style.cursor = 'pointer';
                    canvas.title = 'Clicca per scaricare';
                    canvas.onclick = function() {
                        const link = document.createElement('a');
                        link.download = 'qr-code.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        
                        // Show download feedback
                        const originalTitle = canvas.title;
                        canvas.title = 'Scaricato!';
                        setTimeout(() => {
                            canvas.title = originalTitle;
                        }, 2000);
                    };
                }
            });
        }

        let video = document.getElementById('video');
        let videoContainer = document.getElementById('videoContainer');
        let resultCard = document.getElementById('resultCard');
        let scanning = false;
        let videoStream = null;
        let lastResult = '';

        function parseOtpAuthUri(uri) {
            try {
                const url = new URL(uri);
                
                if (url.protocol !== 'otpauth:') {
                    return null;
                }
                
                // Parse type from pathname
                const pathParts = url.pathname.split('/').filter(p => p);
                const type = pathParts[0] || 'totp';
                
                // Parse label
                const label = decodeURIComponent(pathParts.slice(1).join('/') || '');
                
                // Parse parameters
                const params = {
                    type: type,
                    label: label,
                    secret: url.searchParams.get('secret') || '',
                    issuer: url.searchParams.get('issuer') || '',
                    algorithm: url.searchParams.get('algorithm') || 'SHA1',
                    digits: url.searchParams.get('digits') || '6',
                    period: url.searchParams.get('period') || '30',
                    counter: url.searchParams.get('counter') || ''
                };
                
                // Extract account name from label if available
                if (label && label.includes(':')) {
                    const parts = label.split(':');
                    if (parts.length >= 2) {
                        params.issuerFromLabel = parts[0].trim();
                        params.account = parts.slice(1).join(':').trim();
                    } else {
                        params.account = label;
                    }
                } else {
                    params.account = label;
                }
                
                // Use issuer from label if issuer parameter is not set
                if (!params.issuer && params.issuerFromLabel) {
                    params.issuer = params.issuerFromLabel;
                }
                
                return params;
            } catch (e) {
                console.error('Error parsing OTP URI:', e);
                return null;
            }
        }

        function displayOtpAuthData(otpData) {
            const otpTableContainer = document.getElementById('otpTableContainer');
            const otpTableBody = document.getElementById('otpTableBody');
            const decodedText = document.getElementById('decodedText');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            
            // Clear previous content
            otpTableBody.innerHTML = '';
            decodedText.innerHTML = '';
            
            // Update header
            resultIcon.textContent = 'lock';
            resultIcon.style.color = 'var(--tertiary)';
            resultTitle.textContent = 'Codice 2FA Rilevato';
            resultTitle.innerHTML += `<span class="otp-badge ${otpData.type}">${otpData.type.toUpperCase()}</span>`;
            
            // Show the raw URI
            decodedText.innerHTML = `<strong>URI originale:</strong><br><small style="color: var(--gray); word-break: break-all;">${lastResult}</small>`;
            
            // Add data to table
            const rows = [
                { param: 'Tipo', value: otpData.type.toUpperCase(), copyable: false },
                { param: 'Account', value: otpData.account || 'N/D', copyable: true },
                { param: 'Issuer', value: otpData.issuer || 'N/D', copyable: true },
                { param: 'Secret', value: otpData.secret || 'N/D', copyable: true },
                { param: 'Algoritmo', value: otpData.algorithm, copyable: true },
                { param: 'Cifre', value: otpData.digits, copyable: true }
            ];
            
            if (otpData.type === 'totp') {
                rows.push({ param: 'Periodo', value: otpData.period + ' secondi', copyable: true });
            } else if (otpData.type === 'hotp') {
                rows.push({ param: 'Contatore', value: otpData.counter || '0', copyable: true });
            }
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                
                const tdParam = document.createElement('td');
                tdParam.textContent = row.param;
                tdParam.style.fontWeight = '500';
                
                const tdValue = document.createElement('td');
                tdValue.className = 'value-cell';
                
                const valueSpan = document.createElement('span');
                valueSpan.textContent = row.value;
                
                tdValue.appendChild(valueSpan);
                
                if (row.copyable && row.value !== 'N/D') {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">content_copy</span> Copia';
                    copyBtn.onclick = () => copyToClipboard(row.value);
                    tdValue.appendChild(copyBtn);
                }
                
                tr.appendChild(tdParam);
                tr.appendChild(tdValue);
                otpTableBody.appendChild(tr);
            });
            
            // Show OTP table
            otpTableContainer.style.display = 'block';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show feedback
                const originalButtonText = event.target.textContent;
                event.target.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">check</span> Copiato!';
                event.target.style.background = 'rgba(48, 209, 88, 0.2)';
                event.target.style.borderColor = 'rgba(48, 209, 88, 0.3)';
                event.target.style.color = 'var(--tertiary)';
                
                setTimeout(() => {
                    event.target.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">content_copy</span> Copia';
                    event.target.style.background = '';
                    event.target.style.borderColor = '';
                    event.target.style.color = '';
                }, 2000);
            });
        }

        function displayRegularResult(text) {
            const otpTableContainer = document.getElementById('otpTableContainer');
            const decodedText = document.getElementById('decodedText');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            
            // Reset to regular result display
            otpTableContainer.style.display = 'none';
            resultIcon.textContent = 'check_circle';
            resultIcon.style.color = 'var(--tertiary)';
            resultTitle.textContent = 'Codice rilevato con successo';
            resultTitle.innerHTML = resultTitle.textContent; // Remove any badges
            
            // Check if it's a URL
            const isUrl = /^https?:\/\//.test(text);
            decodedText.innerHTML = isUrl ? 
                `<a href="${text}" target="_blank" style="color: var(--primary); text-decoration: none;">${text}</a>` : 
                text;
        }

        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                videoContainer.classList.add('active');
                resultCard.classList.remove('show');
                
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                })
                .then(function(stream) {
                    video.srcObject = stream;
                    videoStream = stream;

                    video.onloadedmetadata = function() {
                        video.play();
                        scanning = true;
                        scanLoop();
                    };
                })
                .catch(err => {
                    alert("Impossibile accedere alla fotocamera: " + err.message);
                    videoContainer.classList.remove('active');
                });
            } else {
                alert("La fotocamera non è disponibile su questo dispositivo");
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                scanning = false;
                videoContainer.classList.remove('active');
                lastResult = '';
            }
        }

        function scanLoop() {
            if (!scanning) return;

            if (video.videoWidth === 0 || video.videoHeight === 0) {
                requestAnimationFrame(scanLoop);
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);

            if (code && code.data !== lastResult) {
                lastResult = code.data;
                navigator.vibrate && navigator.vibrate([100, 50, 100]);
                
                // Check if it's an OTP auth URI
                if (lastResult.startsWith('otpauth://')) {
                    const otpData = parseOtpAuthUri(lastResult);
                    if (otpData) {
                        displayOtpAuthData(otpData);
                    } else {
                        displayRegularResult(lastResult);
                    }
                } else {
                    displayRegularResult(lastResult);
                }
                
                resultCard.classList.add('show');
                
                // Scroll to result
                resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            requestAnimationFrame(scanLoop);
        }

        // Generate QR on Enter key
        document.getElementById('textInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generateQRCode();
            }
        });

        // Add some interactive effects
        document.querySelectorAll('.card, .button').forEach(element => {
            element.addEventListener('mousedown', function() {
                this.style.transform = 'translateY(0)';
            });
            
            element.addEventListener('mouseup', function() {
                if (this.classList.contains('button')) {
                    this.style.transform = 'translateY(-2px)';
                }
            });
            
            element.addEventListener('mouseleave', function() {
                this.style.transform = '';
            });
        });

        // Add auto-focus to input
        document.getElementById('textInput').focus();
    </script>
</body>
</html>
